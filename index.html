<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Explored by the Shaws</title>

  <!-- Google Font for Modern Look -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@100;300;400;500;600&display=swap" rel="stylesheet" />

  <!-- Set SVG Favicon -->
  <link rel="icon" href="favicon.svg" type="image/svg+xml" />

  <style>
    body {
      margin: 0;
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      background-color: #ffffff;
      color: #1c1c1e;
    }

    header {
      display: flex;
      align-items: center;
      padding: 1.5rem 2rem;
      gap: 0.75rem;
      background-color: rgba(255, 255, 255, 0.9);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
      position: relative;
      z-index: 10;
    }

    .logo svg {
      height: 42px;
      width: 42px;
      fill: #007aff;
    }

    h1 {
      font-size: 2.5rem;
      font-weight: 100;
      margin: 0;
      line-height: 1.1;
    }

    .map-container {
      width: 100%;
      height: calc(100vh - 90px);
      position: relative;
      cursor: crosshair;
    }

    /* Form styling */
    #location-form-container {
      background-color: rgba(255, 255, 255, 0.98);
      border-radius: 16px;
      overflow: hidden;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.15);
      max-width: 500px;
      width: 90%;
    }
    
    #location-form-container h2 {
      font-weight: 400;
      margin-top: 0;
      margin-bottom: 1.5rem;
      color: #1c1c1e;
    }
    
    #location-form-container form {
      display: flex;
      flex-direction: column;
      gap: 1.25rem;
    }
    
    #location-form-container label {
      font-size: 0.9rem;
      font-weight: 500;
      color: #666;
      margin-bottom: 0.25rem;
    }
    
    #location-form-container input,
    #location-form-container select,
    #location-form-container textarea {
      width: 100%;
      padding: 0.75rem;
      font-size: 1rem;
      border-radius: 8px;
      border: 1px solid #ddd;
      background-color: #f9f9f9;
      font-family: inherit;
      transition: border-color 0.2s, box-shadow 0.2s;
    }
    
    #location-form-container input:focus,
    #location-form-container select:focus,
    #location-form-container textarea:focus {
      border-color: #007aff;
      outline: none;
      box-shadow: 0 0 0 3px rgba(0, 122, 255, 0.2);
    }
    
    #location-form-container .button-group {
      display: flex;
      gap: 1rem;
      margin-top: 0.5rem;
    }
    
    #location-form-container button {
      padding: 0.75rem 1.25rem;
      font-size: 1rem;
      border-radius: 8px;
      border: none;
      cursor: pointer;
      font-weight: 500;
      transition: background-color 0.2s, transform 0.1s;
    }
    
    #location-form-container button[type="submit"] {
      background-color: #007aff;
      color: white;
      flex: 1;
    }
    
    #location-form-container button[type="button"] {
      background-color: #f1f1f1;
      color: #555;
    }
    
    #location-form-container button:hover {
      opacity: 0.9;
    }
    
    #location-form-container button:active {
      transform: scale(0.98);
    }

    /* Info Window Styling */
    .gm-style .gm-style-iw-c {
      border-radius: 12px;
      padding: 12px;
    }
    
    .gm-style .gm-style-iw-d {
      overflow: hidden !important;
    }
    
    /* Map pin animation */
    @keyframes pulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.1); }
      100% { transform: scale(1); }
    }
    
    /* Responsive styles */
    @media (max-width: 600px) {
      header {
        padding: 1rem;
        gap: 0.5rem;
      }

      .logo svg {
        height: 26px;
        width: 26px;
      }

      h1 {
        font-size: 1.8rem;
      }
      
      #location-form-container {
        width: 95%;
        padding: 1.5rem;
      }
    }
  </style>
  <script>
    const SHEET_ID = "1wvENHweG4e16n514x2zUR-NJmhp3IrUPxTQUFaGRgg0"; // Google Sheet ID
    const API_KEY = "AIzaSyD4onh-91wzzcsGdBkJxVJ-U6FYnFo3ebQ"; // Your provided API key

    let map; // Ensure map is globally accessible

    async function fetchPins() {
      const url = `https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values/Sheet1?key=${API_KEY}`;
      
      try {
        const response = await fetch(url);
        const data = await response.json();

        if (data.values && data.values.length > 0) {
          // Skip header row if present
          const rows = data.values.length > 1 ? data.values.slice(1) : data.values;
          
          rows.forEach(row => {
            if (row.length >= 5) {
              const year = row[0];
              const lat = parseFloat(row[1]);
              const lng = parseFloat(row[2]);
              const name = row[3];
              const description = row[4];
              const month = row.length > 5 ? row[5] : ""; // In case month is not in older data
              
              if (!isNaN(lat) && !isNaN(lng)) {
                addPinToMap({
                  year,
                  lat,
                  lng,
                  name,
                  description,
                  month
                });
              }
            }
          });
        }
      } catch (error) {
        console.error("Error fetching pins:", error);
      }
    }

    async function addPinToSheet(pin) {
      return new Promise((resolve, reject) => {
        // Log the pin data for debugging
        console.log("Attempting to save pin data:", pin);
        
        // Create an invisible iframe to handle the form submission without page navigation
        const iframe = document.createElement('iframe');
        iframe.name = 'hidden-iframe';
        iframe.style.display = 'none';
        document.body.appendChild(iframe);
        
        // Create a form that will submit to the Google Apps Script
        const form = document.createElement('form');
        form.method = 'POST';
        // Use a cache-busting parameter to avoid caching issues
        form.action = 'https://script.google.com/macros/s/AKfycbzW37f28Lsh1BXBcqpkZ4HFA9z6I4OEhhku8TfXwG9LErxRKAynQLryeR0UJo4LKP6A/exec?_=' + new Date().getTime();
        form.target = 'hidden-iframe';
        
        // Add form fields for each property in the pin object
        for (const key in pin) {
          const input = document.createElement('input');
          input.type = 'hidden';
          input.name = key;
          input.value = pin[key];
          form.appendChild(input);
          console.log(`Added field ${key} with value ${pin[key]}`);
        }
        
        // Add the form to the document
        document.body.appendChild(form);
        
        console.log("Submitting form to Google Apps Script");
        
        // Set a timeout to check Google Sheets after submission
        setTimeout(() => {
          // After a delay, fetch the pins from Google Sheets to see if our new data is there
          fetch(`https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values/Sheet1?key=${API_KEY}`)
            .then(response => response.json())
            .then(data => {
              console.log("Fetched sheet data to verify pin was added:", data);
              // Check the latest row
              if (data.values && data.values.length > 0) {
                const lastRow = data.values[data.values.length - 1];
                console.log("Latest row in sheet:", lastRow);
              }
            })
            .catch(err => console.error("Error verifying pin addition:", err));
        }, 3000); // Check after 3 seconds
        
        // Handle the iframe load event
        iframe.onload = function() {
          console.log("Form submitted successfully");
          
          // Don't try to read the iframe content - it will cause CORS errors
          // Just assume success if we got here
          
          // Clean up
          document.body.removeChild(form);
          document.body.removeChild(iframe);
          resolve(true);
        };
        
        iframe.onerror = function(error) {
          console.error("Error submitting form:", error);
          // Clean up
          document.body.removeChild(form);
          document.body.removeChild(iframe);
          reject(new Error("Failed to submit form"));
        };
        
        // Submit the form
        form.submit();
      });
    }

    function addPinToMap({ year, lat, lng, name, description, month }) {
      const color = getColorByYear(year);

      // Create a DOM element for the marker content
      const markerContent = document.createElement("div");
      markerContent.style.backgroundColor = color;
      markerContent.style.width = "16px";
      markerContent.style.height = "16px";
      markerContent.style.borderRadius = "50%";
      markerContent.style.border = "2px solid white";
      markerContent.style.boxShadow = "0 2px 4px rgba(0,0,0,0.3)";
      markerContent.style.cursor = "pointer"; // Set cursor to pointer for pins
      
      // Create the advanced marker element
      const marker = new google.maps.marker.AdvancedMarkerElement({
        position: { lat, lng },
        map,
        title: name,
        content: markerContent,
        zIndex: 100, // Ensure pins are above other map elements
      });
      
      // Store pin data with marker to ensure it's available on click
      marker.pinData = { year, lat, lng, name, description, month };
      
      // Add direct click handler
      markerContent.addEventListener('click', function(e) {
        e.stopPropagation();
        e.preventDefault();
        
        // Log to debug
        console.log("Pin clicked:", marker.pinData);
        
        // Create info window content
        const contentDiv = document.createElement("div");
        contentDiv.style.padding = "15px";
        contentDiv.style.maxWidth = "300px";
        contentDiv.innerHTML = `
          <h3 style="margin-top: 0;">${name}</h3>
          <p><strong>Year:</strong> ${year}</p>
          <p><strong>Month:</strong> ${month || "N/A"}</p>
          <p><strong>Description:</strong> ${description}</p>
          <p><strong>Location:</strong> ${lat.toFixed(6)}, ${lng.toFixed(6)}</p>
        `;

        // If we already have an active info window, close it
        if (window.activeInfoWindow) {
          window.activeInfoWindow.close();
        }

        // Create a new info window
        const infoWindow = new google.maps.InfoWindow({
          content: contentDiv,
        });

        infoWindow.open({
          map,
          anchor: marker,
        });

        // Store reference to open info window
        window.activeInfoWindow = infoWindow;
        
        return false;
      });
    }

    function getColorByYear(year) {
      // Generate colors based on year (using a consistent algorithm)
      const yearNum = parseInt(year);
      const baseYear = 2018;
      const colorOptions = [
        "#FF5252", // Red
        "#FF9800", // Orange
        "#FFEB3B", // Yellow
        "#4CAF50", // Green
        "#2196F3", // Blue
        "#673AB7", // Purple
        "#E91E63", // Pink
        "#795548"  // Brown
      ];
      
      const index = (yearNum - baseYear) % colorOptions.length;
      return colorOptions[index];
    }

    function populateYearDropdown() {
      const yearSelect = document.getElementById("year");
      yearSelect.innerHTML = ""; // Clear existing options
      
      const currentYear = new Date().getFullYear();
      for (let year = 2018; year <= currentYear; year++) {
        const option = document.createElement("option");
        option.value = year;
        option.textContent = year;
        yearSelect.appendChild(option);
      }
      
      // Set current year as default
      yearSelect.value = currentYear;
    }

    function populateMonthDropdown() {
      const monthSelect = document.getElementById("month");
      monthSelect.innerHTML = ""; // Clear existing options
      
      const months = [
        "January", "February", "March", "April", "May", "June", 
        "July", "August", "September", "October", "November", "December"
      ];
      
      months.forEach((month, index) => {
        const option = document.createElement("option");
        option.value = month;
        option.textContent = month;
        monthSelect.appendChild(option);
      });
      
      // Set current month as default
      const currentMonth = new Date().getMonth();
      monthSelect.selectedIndex = currentMonth;
    }

    // Make sure dropdowns always show current year/month when form opens
    function resetForm() {
      // Reset the form itself
      document.getElementById("location-form-container").querySelector("form").reset();
      
      // Explicitly set the current year and month again
      const currentYear = new Date().getFullYear();
      const currentMonth = new Date().getMonth();
      
      document.getElementById("year").value = currentYear;
      document.getElementById("month").selectedIndex = currentMonth;
    }
    
    function closeForm() {
      document.getElementById("location-form-container").style.display = "none";
      // Reset form values when closing
      resetForm();
    }

    async function handleFormSubmit(event) {
      event.preventDefault();

      const name = document.getElementById("name").value;
      const month = document.getElementById("month").value;
      const description = document.getElementById("description").value;
      const year = document.getElementById("year").value;
      const lat = parseFloat(document.getElementById("latitude").value);
      const lng = parseFloat(document.getElementById("longitude").value);

      const pin = { year, lat, lng, name, description, month };

      addPinToMap(pin);
      await addPinToSheet(pin);

      alert("Pin added successfully!");
      event.target.reset();
      document.getElementById("location-form-container").style.display = "none";
    }

    function initMap() {
      // Clear any existing content in the map container
      const mapContainer = document.querySelector(".map-container");
      mapContainer.innerHTML = "";

      // Initialize the map with a valid Map ID
      map = new google.maps.Map(mapContainer, {
        center: { lat: 39.8283, lng: -98.5795 }, // Center of the US
        zoom: 4,
        mapId: "YOUR_MAP_ID", // Replace with your valid Map ID
        styles: [
          {
            "featureType": "administrative",
            "elementType": "geometry",
            "stylers": [{"visibility": "off"}]
          },
          {
            "featureType": "poi",
            "stylers": [{"visibility": "off"}]
          },
          {
            "featureType": "road",
            "elementType": "labels.icon",
            "stylers": [{"visibility": "off"}]
          },
          {
            "featureType": "transit",
            "stylers": [{"visibility": "off"}]
          }
        ]
      });

      // Fetch and display existing pins from Google Sheets
      fetchPins();

      // Add a click listener to the map
      map.addListener("click", (event) => {
        const lat = event.latLng.lat();
        const lng = event.latLng.lng();

        // Reset form to ensure defaults are current
        resetForm();
        
        // Pre-fill the form with the clicked coordinates
        document.getElementById("latitude").value = lat.toFixed(6);
        document.getElementById("longitude").value = lng.toFixed(6);

        // Show the form as a modal
        const formContainer = document.getElementById("location-form-container");
        formContainer.style.display = "block";
        formContainer.style.position = "fixed";
        formContainer.style.top = "50%";
        formContainer.style.left = "50%";
        formContainer.style.transform = "translate(-50%, -50%)";
        formContainer.style.backgroundColor = "white";
        formContainer.style.padding = "2rem";
        formContainer.style.borderRadius = "12px";
        formContainer.style.boxShadow = "0 8px 30px rgba(0, 0, 0, 0.12)";
        formContainer.style.zIndex = "1000";
      });
    }

    window.initMap = initMap;
    window.onload = () => {
      fetchPins();
      populateYearDropdown();
      populateMonthDropdown();
    };
  </script>
  <script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyD4onh-91wzzcsGdBkJxVJ-U6FYnFo3ebQ&callback=initMap&libraries=marker"></script>
</head>
<body>
  <header>
    <div class="logo">
      <!-- Clean GPS Pin SVG -->
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 384 512">
        <path d="M192 0C86 0 0 86 0 192c0 77.4 108.7 215.3 162.7 276.4 15.5 17.6 42.1 17.6 57.6 0C275.3 407.3 384 269.4 384 192 384 86 298 0 192 0zm0 272a80 80 0 1 1 0-160 80 80 0 1 1 0 160z"/>
      </svg>
    </div>
    <h1>Explored by the Shaws</h1>
  </header>

  <div class="map-container" style="position: relative; height: calc(100vh - 90px);"></div>

  <div id="location-form-container" style="display: none;">
    <h2>Add a New Location</h2>
    <form onsubmit="handleFormSubmit(event)">
      <div>
        <label for="name">Location Name</label>
        <input type="text" id="name" required placeholder="e.g. Paris, France" />
      </div>
      
      <div>
        <label for="month">Month Visited</label>
        <select id="month" required></select>
      </div>
      
      <div>
        <label for="description">Description</label>
        <textarea id="description" required placeholder="What did you do here?" rows="3"></textarea>
      </div>
      
      <div>
        <label for="year">Year Visited</label>
        <select id="year" required></select>
      </div>
      
      <div>
        <label for="latitude">Latitude</label>
        <input type="text" id="latitude" readonly />
      </div>
      
      <div>
        <label for="longitude">Longitude</label>
        <input type="text" id="longitude" readonly />
      </div>
      
      <div class="button-group">
        <button type="submit">Add Location</button>
        <button type="button" onclick="closeForm()">Cancel</button>
      </div>
    </form>
  </div>
</body>
</html>
